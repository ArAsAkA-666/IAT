<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <title>I/E Reaction Test - 7 Phase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: white;
      color: black;
      line-height: 1.5;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    h1, h2, h3 {
      margin: 20px 0 10px 0;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .section {
      margin: 30px 0;
      padding: 20px 0;
      border-bottom: 1px solid #ccc;
    }

    .section:last-child {
      border-bottom: none;
    }

    .form-row {
      margin: 15px 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select, textarea, button {
      padding: 10px;
      border: 2px solid #333;
      background: white;
      font-size: 16px;
      width: 100%;
    }

    button {
      cursor: pointer;
      font-weight: bold;
      margin: 10px 0;
    }

    button:hover {
      background: #f0f0f0;
    }

    .button-row {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

    .button-row button {
      flex: 1;
    }

    .stimulus-area {
      text-align: center;
      padding: 60px 20px;
      margin: 30px 0;
      border: 2px solid #333;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .word {
      font-size: 48px;
      font-weight: bold;
    }

    .word.good {
      color: green;
    }

    .word.bad {
      color: red;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      text-align: center;
    }

    .stat {
      flex: 1;
      padding: 10px;
      border: 1px solid #333;
      margin: 0 5px;
    }

    .progress-bar {
      height: 20px;
      border: 2px solid #333;
      margin: 20px 0;
    }

    .progress {
      height: 100%;
      background: black;
      transition: width 0.3s ease;
    }

    .hidden {
      display: none;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #ccc;
    }

    .instructions-box {
      border: 2px solid #333;
      padding: 20px;
      margin: 20px 0;
      background: #f9f9f9;
    }

    .phase-break {
      border: 3px solid #000;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
      background: #f5f5f5;
    }

    .phase-instructions {
      background: #e8f4fd;
      border: 2px solid #0066cc;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
    }

    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .button-row {
        flex-direction: column;
      }
      
      .stats {
        flex-direction: column;
      }
      
      .stat {
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <h1>–°–ê–ô–ù</h1>
  <h1 style="text-align: right; margin-top: -50px; color: red;">–ú–£–£</h1>

  <div class="subtitle">
    –ó“Ø“Ø–Ω –≥–∞—Ä—ã–Ω –¥—É–Ω–¥ —ç—Ä—Ö–∏–π –¥–æ–ª–æ–æ–≤–æ—Ä —Ö—É—Ä—É—É–≥–∞–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∏–π–Ω –≥–∞—Ä–Ω—ã –ë —Ç–æ–≤—á–ª—É—É—Ä, –±–∞—Ä—É—É–Ω –≥–∞—Ä—ã–Ω –¥—É–Ω–¥ —ç—Ä—Ö–∏–π –¥–æ–ª–æ–æ–≤–æ—Ä —Ö—É—Ä—É—É–≥–∞–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∏–π–Ω –≥–∞—Ä–Ω—ã –¢ —Ç–æ–≤—á–ª—É—É—Ä –¥—ç—ç—Ä —Ç—É—Å —Ç—É—Å –±–∞–π—Ä–ª—É—É–ª.
  </div>

  <!-- Setup -->
  <div id="setup">
    <div class="section">
      <div class="form-row">
        <label>–û—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω ID:</label>
        <input id="participant" placeholder="–ñ–∏—à—ç—ç: 001" required>
      </div>

      <div class="form-grid">
        <div>
          <label>–•“Ø–π—Å:</label>
          <select id="gender" required>
            <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
            <option value="–ú">–≠—Ä—ç–≥—Ç—ç–π</option>
            <option value="–≠">–≠–º—ç–≥—Ç—ç–π</option>
            <option value="–ë">–ë—É—Å–∞–¥</option>
          </select>
        </div>
        <div>
          <label>–ù–∞—Å:</label>
          <input id="age" type="number" placeholder="–ñ–∏—à—ç—ç: 25" min="1" max="120" required>
        </div>
      </div>

      <input id="minRt" type="hidden" value="200">
    </div>

    <div class="instructions-box">
      <p><strong>–≠–Ω—ç —Ç–µ—Å—Ç 7 ”©”©—Ä —Ö—ç—Å—ç–≥—Ç—ç–π –±”©–≥”©”©–¥ —Ö—ç—Å—ç–≥ –±“Ø—Ä—Ç ”©”©—Ä –∑–∞–∞–≤–∞—Ä –±–∞–π–Ω–∞.</strong></p>
      <p><strong>–î—ç–ª–≥—ç—Ü–∏–π–Ω –¥—ç—ç—Ä “Ø–≥ –≥–∞—Ä—á –∏—Ä—ç—Ö—ç–¥ –°–ê–ô–ù —ç—Å–≤—ç–ª –ú–£–£-–¥ —Ö–∞–º—Ä–∞—Ö —ç—Å—ç—Ö–∏–π–≥ —à–∏–π–¥—ç—ç–¥ —Ç–æ—Ö–∏—Ä–æ—Ö —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–Ω–∞ —É—É.</strong></p>
      <p><strong>–ë —Ç–æ–≤—á = –°–ê–ô–ù (–Ω–æ–≥–æ–æ–Ω ”©–Ω–≥”©—Ç—ç–π)</strong></p>
      <p><strong>–¢ —Ç–æ–≤—á = –ú–£–£ (—É–ª–∞–∞–Ω ”©–Ω–≥”©—Ç—ç–π)</strong></p>
      <br>
      <p><strong>–ê–ª—å –±–æ–ª–æ—Ö —Ö—É—Ä–¥–∞–Ω –±”©–≥”©”©–¥ –∑”©–≤ —Ö–∞—Ä–∏—É–ª–∞—Ö—ã–≥ —Ö–∏—á—ç—ç–≥—ç—ç—Ä—ç–π!</strong></p>
      <br>
      <p><strong>–ó–ê–ô –ê–í–ê–• –¢–û–í–ß–õ–£–£–† –¥–∞—Ä–∂ —ç—Ö—ç–ª–Ω—ç “Ø“Ø.</strong></p>
    </div>

    <button id="btnStart">–ó–ê–ô –ê–í–ê–• –¢–û–í–ß–õ–£–£–† (Space)</button>
  </div>

  <!-- Phase Instructions -->
  <div id="phaseInstructions" class="hidden">
    <div class="phase-instructions">
      <h3 id="phaseInstructionsTitle">1-—Ä —Ö—ç—Å–≥–∏–π–Ω –∑–∞–∞–≤–∞—Ä</h3>
      <div id="phaseInstructionsContent">
        <!-- Content will be filled by JavaScript -->
      </div>
      <button id="btnStartPhase">–•—ç—Å–≥–∏–π–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö</button>
    </div>
  </div>

  <!-- Test Stage -->
  <div id="stage" class="hidden">
    <h3 id="phaseTitle">1-—Ä —Ö—ç—Å—ç–≥</h3>
    
    <div class="stats">
      <div class="stat">–•—ç—Å—ç–≥: <strong id="currentPhase">1</strong>/7</div>
      <div class="stat">“Æ–≥: <strong id="idx">0</strong>/<strong id="total">0</strong></div>
      <div class="stat">–ó”©–≤: <strong id="validCount">0</strong></div>
      <div class="stat">–ë—É—Ä—É—É: <strong id="invalidCount">0</strong></div>
    </div>

    <div class="progress-bar">
      <div class="progress" id="progress" style="width: 0%"></div>
    </div>

    <div class="stimulus-area" id="stimulusArea">
      <div class="word" id="word">–ë—ç–ª—ç–Ω –±–æ–ª—Å–æ–Ω —É—É?</div>
    </div>

    <div class="button-row">
      <button id="btnGood" style="background: #90EE90; color: black;">–ë (–°–ê–ô–ù)</button>
      <button id="btnBad" style="background: #FFB6C1; color: black;">–¢ (–ú–£–£)</button>
    </div>

    <div class="button-row">
      <button id="btnUndo">–°“Ø“Ø–ª—á–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ –±—É—Ü–∞–∞—Ö</button>
      <button id="btnFinish">–¢—É—Ä—à–∏–ª—Ç—ã–≥ –¥—É—É—Å–≥–∞—Ö</button>
    </div>
  </div>

  <!-- Phase Break -->
  <div id="phaseBreak" class="hidden">
    <div class="phase-break">
      <h3 id="breakTitle">1-—Ä —Ö—ç—Å—ç–≥ –¥—É—É—Å–ª–∞–∞!</h3>
      <p id="breakMessage">–î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö—ç—Å—ç–≥ —Ä“Ø“Ø —à–∏–ª–∂–∏—Ö.</p>
      <button id="btnNextPhase">–î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö—ç—Å—ç–≥ —Ä“Ø“Ø</button>
    </div>
  </div>

  <!-- Results -->
  <div id="result" class="hidden">
    <h2>“Æ—Ä –¥“Ø–Ω</h2>

    <div class="section">
      <div id="summary"></div>
    </div>

    <div class="section">
      <h3>“Æ—Ä –¥“Ø–Ω–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö</h3>
      <button id="btnDownloadCsv">CSV —Ñ–∞–π–ª —Ç–∞—Ç–∞—Ö</button>
      <div id="status" style="margin-top: 12px; padding: 10px; border: 1px solid #ccc;" class="hidden"></div>
    </div>

    <div class="section">
      <h3>–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª</h3>
      <label>Debug JSON:</label>
      <textarea id="debug" rows="10"></textarea>
    </div>
  </div>

<script>
  // ===== 1) –¢–æ—Ö–∏—Ä–≥–æ–æ =====
  const WORDS = [
    "Happy", "Sad", "Love", "Anger", "Peace", "Hate", "Proud", "Shame", "Smile", "Fear",
    "Joy", "Pain", "Friend", "Enemy", "Warm", "Cold", "Beautiful", "Ugly", "Success", "Failure",
    "Hope", "Despair", "Trust", "Betrayal", "Kindness", "Cruelty", "Honest", "Lie", "Brave", "Coward"
  ];

  const PHASES = [
    { 
      name: "1-—Ä —Ö—ç—Å—ç–≥: –≠–µ—Ä—ç–≥ “Ø–≥—Å", 
      type: "positive_words",
      instruction: "–≠–µ—Ä—ç–≥ —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç”©—Ä“Ø“Ø–ª–¥—ç–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á), —Å”©—Ä”©–≥ —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç”©—Ä“Ø“Ø–ª–¥—ç–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á) –≥—ç–∂ –∞–Ω–≥–∏–ª–Ω–∞ —É—É."
    },
    { 
      name: "2-—Ä —Ö—ç—Å—ç–≥: –°”©—Ä”©–≥ “Ø–≥—Å", 
      type: "negative_words",
      instruction: "–°”©—Ä”©–≥ —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç”©—Ä“Ø“Ø–ª–¥—ç–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á), —ç–µ—Ä—ç–≥ —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç”©—Ä“Ø“Ø–ª–¥—ç–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á) –≥—ç–∂ –∞–Ω–≥–∏–ª–Ω–∞ —É—É."
    },
    { 
      name: "3-—Ä —Ö—ç—Å—ç–≥: –•–æ–ª–∏–º–æ–≥ “Ø–≥—Å 1", 
      type: "mixed_1",
      instruction: "–≠–µ—Ä—ç–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á), —Å”©—Ä”©–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á) –≥—ç–∂ —Ö—É—Ä–¥–∞–Ω –∞–Ω–≥–∏–ª–Ω–∞ —É—É."
    },
    { 
      name: "4-—Ä —Ö—ç—Å—ç–≥: –≠—Å—Ä—ç–≥ –∞–Ω–≥–∏–ª–∞–ª", 
      type: "reverse",
      instruction: "–ê–ù–•–ê–ê–†: –û–¥–æ–æ —ç—Å—Ä—ç–≥—ç—ç—Ä—ç—ç –∞–Ω–≥–∏–ª–Ω–∞! –≠–µ—Ä—ç–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á), —Å”©—Ä”©–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á) –≥—ç–∂ –¥–∞—Ä–Ω–∞ —É—É."
    },
    { 
      name: "5-—Ä —Ö—ç—Å—ç–≥: –•–æ–ª–∏–º–æ–≥ “Ø–≥—Å 2", 
      type: "mixed_2",
      instruction: "–î–∞—Ö–∏–Ω —Ö—ç–≤–∏–π–Ω –¥–∞—Ä–∞–ª–ª–∞–∞—Ä: –≠–µ—Ä—ç–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á), —Å”©—Ä”©–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á) –≥—ç–∂ –∞–Ω–≥–∏–ª–Ω–∞ —É—É."
    },
    { 
      name: "6-—Ä —Ö—ç—Å—ç–≥: –¢“Ø—Ä–≥—ç–Ω —à–∏–π–¥–≤—ç—Ä", 
      type: "fast_decision",
      instruction: "–•–∞–º–≥–∏–π–Ω —Ö—É—Ä–¥–∞–Ω —à–∏–π–¥–≤—ç—Ä –≥–∞—Ä–≥–∞! –≠–µ—Ä—ç–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á), —Å”©—Ä”©–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á)."
    },
    { 
      name: "7-—Ä —Ö—ç—Å—ç–≥: –≠—Ü—Å–∏–π–Ω —Ç–µ—Å—Ç", 
      type: "final_test",
      instruction: "–°“Ø“Ø–ª—á–∏–π–Ω —Ö—ç—Å—ç–≥: –≠–µ—Ä—ç–≥ “Ø–≥—Å–∏–π–≥ –°–ê–ô–ù (–ë —Ç–æ–≤—á), —Å”©—Ä”©–≥ “Ø–≥—Å–∏–π–≥ –ú–£–£ (–¢ —Ç–æ–≤—á) –≥—ç–∂ –∞–Ω–≥–∏–ª–Ω–∞ —É—É."
    }
  ];

  const POSITIVE_WORDS = ["Happy", "Love", "Peace", "Proud", "Smile", "Joy", "Friend", "Warm", "Beautiful", "Success", "Hope", "Trust", "Kindness", "Honest", "Brave"];
  const NEGATIVE_WORDS = ["Sad", "Anger", "Hate", "Shame", "Fear", "Pain", "Enemy", "Cold", "Ugly", "Failure", "Despair", "Betrayal", "Cruelty", "Lie", "Coward"];

  const SHUFFLE = true;
  const SAME_KEY_SPAM_WINDOW = 5;
  const SAME_KEY_SPAM_RT = 250;

  const AUTO_EMAIL_ENDPOINT = "https://script.google.com/macros/s/AKfycbyabOqbrxqIXXE_gI0W-ykvOJY1zSLAZr4s3NegM054vn4RIcfJMpY2CgB8JDJReG0z/exec";

  // ===== 2) –¢”©–ª”©–≤ =====
  let currentPhase = 0;
  let seq = [];
  let i = 0;
  let startTime = 0;
  let records = [];
  let minValidRt = 200;
  let participantData = {};

  let lastAnswers = [];
  let lastRTs = [];

  // ===== 3) –≠–ª–µ–º–µ–Ω—Ç–∏–π–Ω —Ö–æ–ª–±–æ–æ—Å =====
  const elSetup = document.getElementById('setup');
  const elPhaseInstructions = document.getElementById('phaseInstructions');
  const elStage = document.getElementById('stage');
  const elPhaseBreak = document.getElementById('phaseBreak');
  const elResult = document.getElementById('result');
  const elWord = document.getElementById('word');
  const elIdx = document.getElementById('idx');
  const elTotal = document.getElementById('total');
  const elValid = document.getElementById('validCount');
  const elInvalid = document.getElementById('invalidCount');
  const elSummary = document.getElementById('summary');
  const elDebug = document.getElementById('debug');
  const elStatus = document.getElementById('status');
  const elProgress = document.getElementById('progress');
  const elPhaseTitle = document.getElementById('phaseTitle');
  const elCurrentPhase = document.getElementById('currentPhase');

  // ===== 4) –¢—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ =====
  function shuffle(a) {
    for (let j = a.length - 1; j > 0; j--) {
      const k = Math.floor(Math.random() * (j + 1));
      [a[j], a[k]] = [a[k], a[j]];
    }
    return a;
  }

  function nowTs() {
    return new Date().toISOString();
  }

  function getFormData(formId) {
    const data = {};
    const form = document.getElementById(formId) || document;
    
    form.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.type === 'radio') {
        if (el.checked) data[el.name] = el.value;
      } else if (el.id && el.value !== '') {
        data[el.id] = el.value;
      }
    });
    
    return data;
  }

  function getWordsForPhase(phaseType) {
    switch(phaseType) {
      case 'positive_words':
        return shuffle([...POSITIVE_WORDS]);
      case 'negative_words':
        return shuffle([...NEGATIVE_WORDS]);
      case 'mixed_1':
      case 'mixed_2':
      case 'reverse':
      case 'fast_decision':
      case 'final_test':
        return shuffle([...POSITIVE_WORDS.slice(0, 10), ...NEGATIVE_WORDS.slice(0, 10)]);
      default:
        return shuffle([...WORDS]);
    }
  }

  function isPositiveWord(word) {
    return POSITIVE_WORDS.includes(word);
  }

  function pushAnswer(answer, rt, word) {
    lastAnswers.push(answer);
    lastRTs.push(rt);
    if (lastAnswers.length > SAME_KEY_SPAM_WINDOW) {
      lastAnswers.shift(); lastRTs.shift();
    }
    let spamSeries = false;
    if (lastAnswers.length === SAME_KEY_SPAM_WINDOW) {
      const allSame = lastAnswers.every(v => v === lastAnswers[0]);
      const avgRt = lastRTs.reduce((a,b)=>a+b,0)/lastRTs.length;
      if (allSame && avgRt < SAME_KEY_SPAM_RT) spamSeries = true;
    }
    const invalid = (rt < minValidRt) || spamSeries;

    // Determine correct answer based on phase
    let correctAnswer;
    const phase = PHASES[currentPhase];
    const isPositive = isPositiveWord(word);
    
    if (phase.type === 'reverse') {
      correctAnswer = isPositive ? 'BAD' : 'GOOD';
    } else {
      correctAnswer = isPositive ? 'GOOD' : 'BAD';
    }

    const isCorrect = answer === correctAnswer;

    records.push({
      idx: i+1,
      phase: currentPhase + 1,
      phase_type: phase.type,
      phase_name: phase.name,
      word: word,
      word_type: isPositive ? 'positive' : 'negative',
      answer,
      correct_answer: correctAnswer,
      is_correct: isCorrect,
      rt_ms: rt,
      ts: nowTs(),
      participant: participantData.participant || '',
      gender: participantData.gender || '',
      age: participantData.age || '',
      valid: !invalid,
      reason: invalid ? (rt < minValidRt ? `too_fast_${rt}ms` : 'spam_series') : ''
    });
  }

  function updateCounters() {
    const currentPhaseRecords = records.filter(r => r.phase === currentPhase + 1);
    const validRecords = currentPhaseRecords.filter(r => r.valid);
    const validN = validRecords.length;
    const invalidN = currentPhaseRecords.length - validN;
    
    elValid.textContent = validN;
    elInvalid.textContent = invalidN;
    elIdx.textContent = Math.min(currentPhaseRecords.length + 1, seq.length);
    elCurrentPhase.textContent = currentPhase + 1;

    const progress = (currentPhaseRecords.length / seq.length) * 100;
    elProgress.style.width = `${progress}%`;
  }

  function toCSV(rows) {
    const cols = ["idx","phase","phase_type","phase_name","word","word_type","answer","correct_answer","is_correct","rt_ms","ts","participant","gender","age","valid","reason"];
    const header = cols.join(",");
    const body = rows.map(r => cols.map(c => {
      const v = r[c];
      const s = String(v ?? "");
      return `"${s.replace(/"/g,'""')}"`;
    }).join(",")).join("\n");
    return header + "\n" + body;
  }

  function downloadFile(name, content, mime="text/csv") {
    const blob = new Blob([content], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function showStatus(message, type = "info") {
    elStatus.textContent = message;
    elStatus.className = "";
    elStatus.style.backgroundColor = type === "success" ? "#e7f5e7" : type === "error" ? "#ffeaea" : "#fff4e6";
    elStatus.classList.remove("hidden");

    if (type === "success" || type === "error") {
      setTimeout(() => {
        elStatus.classList.add("hidden");
      }, 5000);
    }
  }

  async function sendAutoEmail(payload) {
    try {
      showStatus("üìß “Æ—Ä –¥“Ø–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...", "info");

      const res = await fetch(AUTO_EMAIL_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
        mode: 'no-cors'
      });

      showStatus("‚úÖ “Æ—Ä –¥“Ø–Ω –∞–º–∂–∏–ª—Ç—Ç–∞–π amarmarker@gmail.com —Ä—É—É –∏–ª–≥—ç—ç–≥–¥–ª—ç—ç!", "success");

    } catch (error) {
      console.error('Auto email error:', error);
      showStatus("‚ùå –ê–≤—Ç–æ–º–∞—Ç –∏–º—ç–π–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: " + error.message, "error");
    }
  }

  // ===== 5) Event Handlers =====

  document.getElementById('btnStart').addEventListener('click', startTest);
  
  function startTest() {
    participantData = getFormData('setup');
    
    if (!participantData.participant) {
      showStatus("‚ö†Ô∏è –û—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω ID –æ—Ä—É—É–ª–Ω–∞ —É—É.", "error");
      return;
    }
    
    if (!participantData.gender) {
      showStatus("‚ö†Ô∏è –•“Ø–π—Å —Å–æ–Ω–≥–æ–Ω–æ —É—É.", "error");
      return;
    }
    
    if (!participantData.age) {
      showStatus("‚ö†Ô∏è –ù–∞—Å –æ—Ä—É—É–ª–Ω–∞ —É—É.", "error");
      return;
    }

    const age = parseInt(participantData.age, 10);
    if (age < 1 || age > 120) {
      showStatus("‚ö†Ô∏è –ù–∞—Å—ã–≥ –∑”©–≤ –æ—Ä—É—É–ª–Ω–∞ —É—É (1-120).", "error");
      return;
    }

    minValidRt = parseInt(participantData.minRt || "200", 10);

    if (minValidRt < 100) {
      showStatus("‚ö†Ô∏è Anti-spam –±–æ—Å–≥–æ —Ö—ç—Ç –±–∞–≥–∞ –±–∞–π–Ω–∞.", "error");
      return;
    }

    showPhaseInstructions();
  }

  function showPhaseInstructions() {
    const phase = PHASES[currentPhase];
    document.getElementById('phaseInstructionsTitle').textContent = phase.name + " - –ó–∞–∞–≤–∞—Ä";
    document.getElementById('phaseInstructionsContent').innerHTML = `<p><strong>${phase.instruction}</strong></p>`;
    
    elSetup.classList.add('hidden');
    elStage.classList.add('hidden');
    elPhaseBreak.classList.add('hidden');
    elPhaseInstructions.classList.remove('hidden');
  }

  document.getElementById('btnStartPhase').addEventListener('click', initializePhase);

  function initializePhase() {
    const phase = PHASES[currentPhase];
    seq = getWordsForPhase(phase.type);

    i = 0;
    elTotal.textContent = seq.length;
    elPhaseTitle.textContent = phase.name;
    
    elPhaseInstructions.classList.add('hidden');
    elPhaseBreak.classList.add('hidden');
    elStage.classList.remove('hidden');

    elWord.textContent = "3";
    elWord.className = "word";
    setTimeout(() => {
      elWord.textContent = "2";
      setTimeout(() => {
        elWord.textContent = "1";
        setTimeout(() => {
          showStimulus();
        }, 1000);
      }, 1000);
    }, 1000);
  }

  function showStimulus() {
    if (i >= seq.length) return endPhase();
    
    const word = seq[i];
    const isPositive = isPositiveWord(word);
    
    elWord.textContent = word;
    elWord.className = "word";
    
    // Add color based on word type for visual feedback
    if (isPositive) {
      elWord.classList.add("good");
    } else {
      elWord.classList.add("bad");
    }
    
    startTime = performance.now();
    updateCounters();
  }

  function answer(a) {
    const rt = Math.round(performance.now() - startTime);
    const word = seq[i];
    pushAnswer(a, rt, word);
    i++;
    if (i < seq.length) showStimulus(); else endPhase();
  }

  function endPhase() {
    if (currentPhase < PHASES.length - 1) {
      elStage.classList.add('hidden');
      elPhaseBreak.classList.remove('hidden');
      
      document.getElementById('breakTitle').textContent = `${currentPhase + 1}-—Ä —Ö—ç—Å—ç–≥ –¥—É—É—Å–ª–∞–∞!`;
      document.getElementById('breakMessage').textContent = `–î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö—ç—Å—ç–≥: ${PHASES[currentPhase + 1].name}`;
    } else {
      finish();
    }
  }

  document.getElementById('btnNextPhase').addEventListener('click', () => {
    currentPhase++;
    showPhaseInstructions();
  });

  document.getElementById('btnGood').addEventListener('click', ()=>answer('GOOD'));
  document.getElementById('btnBad').addEventListener('click', ()=>answer('BAD'));

  document.getElementById('btnUndo').addEventListener('click', () => {
    const currentPhaseRecords = records.filter(r => r.phase === currentPhase + 1);
    if (!currentPhaseRecords.length) {
      showStatus("–ë—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π —Ö–∞—Ä–∏—É–ª—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.", "error");
      return;
    }
    
    for (let idx = records.length - 1; idx >= 0; idx--) {
      if (records[idx].phase === currentPhase + 1) {
        records.splice(idx, 1);
        break;
      }
    }
    
    i = Math.max(0, i - 1);
    if (lastAnswers.length > 0) lastAnswers.pop();
    if (lastRTs.length > 0) lastRTs.pop();
    showStimulus();
    showStatus("–°“Ø“Ø–ª—á–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –±—É—Ü–∞–∞–≤.", "success");
  });

  document.getElementById('btnFinish').addEventListener('click', () => {
    if (confirm("–¢—É—Ä—à–∏–ª—Ç—ã–≥ –¥—É—É—Å–≥–∞—Ö —É—É?")) {
      finish();
    }
  });

  function finish() {
    elStage.classList.add('hidden');
    elPhaseBreak.classList.add('hidden');
    elResult.classList.remove('hidden');

    const validRows = records.filter(r => r.valid);
    
    const phaseStats = PHASES.map((phase, idx) => {
      const phaseRecords = validRows.filter(r => r.phase === idx + 1);
      const correctAnswers = phaseRecords.filter(r => r.is_correct).length;
      const avgGood = average(phaseRecords.filter(r => r.answer === 'GOOD').map(r=>r.rt_ms));
      const avgBad = average(phaseRecords.filter(r => r.answer === 'BAD').map(r=>r.rt_ms));
      const accuracy = phaseRecords.length > 0 ? (correctAnswers / phaseRecords.length * 100) : 0;
      
      return {
        phase: idx + 1,
        name: phase.name,
        type: phase.type,
        total: records.filter(r => r.phase === idx + 1).length,
        valid: phaseRecords.length,
        invalid: records.filter(r => r.phase === idx + 1 && !r.valid).length,
        correct: correctAnswers,
        accuracy: accuracy,
        avgGood: avgGood,
        avgBad: avgBad
      };
    });

    const totalTime = validRows.reduce((sum, r) => sum + r.rt_ms, 0);
    const totalCorrect = validRows.filter(r => r.is_correct).length;
    const totalAccuracy = validRows.length > 0 ? (totalCorrect / validRows.length * 100) : 0;

    let summaryHTML = `
      <div class="result-item">
        <div>–û—Ä–æ–ª—Ü–æ–≥—á:</div>
        <div><strong>${participantData.participant}</strong></div>
      </div>
      <div class="result-item">
        <div>–•“Ø–π—Å:</div>
        <div><strong>${participantData.gender === '–ú' ? '–≠—Ä—ç–≥—Ç—ç–π' : participantData.gender === '–≠' ? '–≠–º—ç–≥—Ç—ç–π' : '–ë—É—Å–∞–¥'}</strong></div>
      </div>
      <div class="result-item">
        <div>–ù–∞—Å:</div>
        <div><strong>${participantData.age}</strong></div>
      </div>
      <div class="result-item">
        <div>–ù–∏–π—Ç —Ö–∞—Ä–∏—É–ª—Ç (–±“Ø—Ö —Ö—ç—Å—ç–≥):</div>
        <div><strong>${records.length}</strong></div>
      </div>
      <div class="result-item">
        <div>–ó”©–≤ —Ö–∞—Ä–∏—É–ª—Ç (–±“Ø—Ö —Ö—ç—Å—ç–≥):</div>
        <div><strong>${validRows.length}</strong></div>
      </div>
      <div class="result-item">
        <div>–ù–∏–π—Ç –∑”©–≤—Ç—ç–π —Ö–∞—Ä–∏—É–ª—Ç:</div>
        <div><strong>${totalCorrect}</strong></div>
      </div>
      <div class="result-item">
        <div>–ù–∏–π—Ç –Ω–∞—Ä–∏–π–≤—á–ª–∞–ª:</div>
        <div><strong>${Math.round(totalAccuracy)}%</strong></div>
      </div>
      <div class="result-item">
        <div>–ù–∏–π—Ç –∑–∞—Ä—Ü—É—É–ª—Å–∞–Ω —Ö—É–≥–∞—Ü–∞–∞:</div>
        <div><strong>${Math.round(totalTime/1000)} —Å–µ–∫—É–Ω–¥</strong></div>
      </div>
    `;

    phaseStats.forEach(stat => {
      summaryHTML += `
        <div class="result-item" style="margin-top: 20px; border-top: 2px solid #333; padding-top: 12px;">
          <div><strong>${stat.name}</strong></div>
          <div></div>
        </div>
        <div class="result-item">
          <div>–ù–∏–π—Ç —Ö–∞—Ä–∏—É–ª—Ç:</div>
          <div><strong>${stat.total}</strong></div>
        </div>
        <div class="result-item">
          <div>–ó”©–≤ —Ö–∞—Ä–∏—É–ª—Ç:</div>
          <div><strong>${stat.valid}</strong></div>
        </div>
        <div class="result-item">
          <div>–ó”©–≤—Ç—ç–π —Ö–∞—Ä–∏—É–ª—Ç:</div>
          <div><strong>${stat.correct}</strong></div>
        </div>
        <div class="result-item">
          <div>–ù–∞—Ä–∏–π–≤—á–ª–∞–ª:</div>
          <div><strong>${Math.round(stat.accuracy)}%</strong></div>
        </div>
        <div class="result-item">
          <div>–°–ê–ô–ù –¥—É–Ω–¥–∞–∂ RT:</div>
          <div><strong>${isFinite(stat.avgGood)?Math.round(stat.avgGood):'-'} ms</strong></div>
        </div>
        <div class="result-item">
          <div>–ú–£–£ –¥—É–Ω–¥–∞–∂ RT:</div>
          <div><strong>${isFinite(stat.avgBad)?Math.round(stat.avgBad):'-'} ms</strong></div>
        </div>
      `;
    });

    elSummary.innerHTML = summaryHTML;

    const payload = {
      meta: {
        generated_at: nowTs(),
        participant: participantData.participant,
        gender: participantData.gender,
        age: participantData.age,
        min_valid_rt_ms: minValidRt,
        same_key_spam_window: SAME_KEY_SPAM_WINDOW,
        same_key_spam_rt_ms: SAME_KEY_SPAM_RT,
        total_records: records.length,
        total_valid: validRows.length,
        total_invalid: records.length - validRows.length,
        total_correct: totalCorrect,
        total_accuracy: totalAccuracy,
        total_time_ms: totalTime,
        phases: phaseStats
      },
      participant_data: participantData,
      test_records: records,
      csv_data: toCSV(records)
    };

    elDebug.value = JSON.stringify(payload, null, 2);

    sendAutoEmail(payload);

    document.getElementById('btnDownloadCsv').onclick = () => {
      const csv = toCSV(records);
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const filename = `ie_test_7phase_${participantData.participant.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.csv`;
      downloadFile(filename, csv, "text/csv");
      showStatus("CSV —Ñ–∞–π–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ç–∞—Ç–∞–≥–¥–ª–∞–∞.", "success");
    };
  }

  function average(a) {
    if (!a.length) return NaN;
    return a.reduce((x,y)=>x+y,0)/a.length;
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Space key to start test (only when on setup screen)
    if (!elSetup.classList.contains('hidden') && e.code === 'Space') {
      e.preventDefault();
      startTest();
      return;
    }

    // Space key to start phase (when on phase instructions screen)
    if (!elPhaseInstructions.classList.contains('hidden') && e.code === 'Space') {
      e.preventDefault();
      initializePhase();
      return;
    }

    // Test controls (only when test is running)
    if (elStage.classList.contains('hidden')) return;

    if (e.key === 'b' || e.key === 'B') {
      document.getElementById('btnGood').click();
      document.getElementById('btnGood').style.background = '#7FFF7F';
      setTimeout(() => {
        document.getElementById('btnGood').style.background = '#90EE90';
      }, 150);
    } else if (e.key === 't' || e.key === 'T') {
      document.getElementById('btnBad').click();
      document.getElementById('btnBad').style.background = '#FF9999';
      setTimeout(() => {
        document.getElementById('btnBad').style.background = '#FFB6C1';
      }, 150);
    } else if (e.key === 'z' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      document.getElementById('btnUndo').click();
    }
  });
</script>
</body>
</html>
